<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Storage å›¾ç‰‡ä¸Šä¼ </title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
    }
    h2 {
      margin-bottom: 10px;
    }
    .upload-box {
      border: 2px dashed #aaa;
      padding: 30px;
      width: 420px;
      text-align: center;
      margin-bottom: 30px;
    }
    #gallery {
      min-height: 120px;
    }
    .img-item {
      display: inline-block;
      margin: 12px;
      text-align: center;
    }
    .img-item img {
      width: 150px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,.2);
      display: block;
    }
    .progress-bar {
      width: 150px;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.2s;
    }
    .percent {
      font-size: 12px;
      margin-top: 4px;
      color: #333;
    }
  </style>
</head>
<body>

<h2>Firebase Storage å›¾ç‰‡ä¸Šä¼ </h2>

<div class="upload-box">
  <input type="file" id="fileInput" multiple accept="image/*">
  <p>é€‰æ‹©å›¾ç‰‡åè‡ªåŠ¨ä¸Šä¼ </p>
</div>

<h3>å·²ä¸Šä¼ å›¾ç‰‡</h3>
<div id="gallery"></div>

<script>
/* ğŸ”¥ Firebase é…ç½®ï¼ˆä½ çš„é¡¹ç›®ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyD8YicJbBiAgk8YNxE2Nl_e4OrmRG2-tJ8",
  authDomain: "pictures-8e712.firebaseapp.com",
  projectId: "pictures-8e712",
  storageBucket: "pictures-8e712.appspot.com",
  messagingSenderId: "422349091954",
  appId: "1:422349091954:web:fc0c7b9e6c5346b1f1beeb"
};

/* åˆå§‹åŒ– Firebase */
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

const input = document.getElementById("fileInput");
const gallery = document.getElementById("gallery");

/* é€‰æ‹©å›¾ç‰‡ */
input.addEventListener("change", () => {
  [...input.files].forEach(file => {
    createPreviewAndUpload(file);
  });
});

/* åˆ›å»ºé¢„è§ˆ + ä¸Šä¼  + è¿›åº¦æ¡ */
function createPreviewAndUpload(file) {
  const wrapper = document.createElement("div");
  wrapper.className = "img-item";

  const img = document.createElement("img");

  const progressBar = document.createElement("div");
  progressBar.className = "progress-bar";

  const progressInner = document.createElement("div");
  progressInner.className = "progress-inner";

  progressBar.appendChild(progressInner);

  const percentText = document.createElement("div");
  percentText.className = "percent";
  percentText.innerText = "0%";

  wrapper.appendChild(img);
  wrapper.appendChild(progressBar);
  wrapper.appendChild(percentText);
  gallery.appendChild(wrapper);

  /* æœ¬åœ°é¢„è§ˆ */
  const reader = new FileReader();
  reader.onload = e => img.src = e.target.result;
  reader.readAsDataURL(file);

  /* Firebase ä¸Šä¼ å¹¶ç›‘å¬è¿›åº¦ */
  const ref = storage.ref("images/" + Date.now() + "_" + file.name);
  const uploadTask = ref.put(file);

  uploadTask.on(
    "state_changed",
    snapshot => {
      const progress =
        (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      progressInner.style.width = progress + "%";
      percentText.innerText = Math.floor(progress) + "%";
    },
    error => {
      percentText.innerText = "ä¸Šä¼ å¤±è´¥";
      percentText.style.color = "red";
      console.error(error);
    },
    () => {
      ref.getDownloadURL().then(url => {
        img.src = url;               // åˆ‡æ¢ä¸ºäº‘ç«¯å›¾ç‰‡
        percentText.innerText = "å·²ä¸Šä¼ ";
        saveImage(url);
      });
    }
  );
}

/* ä¿å­˜å›¾ç‰‡ URLï¼ˆåˆ·æ–°ä¸ä¸¢ï¼‰ */
function saveImage(url) {
  const images = JSON.parse(localStorage.getItem("images") || "[]");
  images.push(url);
  localStorage.setItem("images", JSON.stringify(images));
}

/* é¡µé¢åŠ è½½æ¢å¤ */
window.onload = () => {
  const images = JSON.parse(localStorage.getItem("images") || "[]");
  images.forEach(url => {
    const wrapper = document.createElement("div");
    wrapper.className = "img-item";

    const img = document.createElement("img");
    img.src = url;

    const percentText = document.createElement("div");
    percentText.className = "percent";
    percentText.innerText = "å·²ä¸Šä¼ ";

    wrapper.appendChild(img);
    wrapper.appendChild(percentText);
    gallery.appendChild(wrapper);
  });
};
</script>
</body>
</html>
